import{r as u,m as Ue,a as U,n as je,p as _t,q as pt,s as ht,c as j,b as t,d as a,t as We,v as ie,e as C,x as _,f as yt,y as gt,w as v,z as I,E as z,A as Ye,u as bt,o as D,j as y,B as re,C as ce,F as Ke,D as qe,G as xt}from"./index-CSIV7qOm.js";import{g as wt,a as Ct,b as St,c as H,i as ue,L as de}from"./monitoring_new-VB7aKBvM.js";import{_ as Et}from"./_plugin-vue_export-helper-DlAUqK2U.js";const ee={"EX EX1 [239587]":"IP1","EX EX2 [239614]":"EX1-2","EX EX3 [239599]":"EX1-3","EX EX4 [239611]":"EX1-4","EX EX5 [239608]":"EX1-5","EX EX6 [239590]":"EX1-6","EX EX7 [239593]":"EX1-7","EX EX8 [239602]":"EX1-8","EX EX9 [239596]":"EX1-9","EX EX10 [239584]":"EX1-10","IP IP1 [257492]":"IP1","IP IP2 [253389]":"IP2","IP IP3 [257472]":"IP3","PL2 IP6(倒锤线) [268515]":"IP6-CH1",IP6:"PL2 IP6(倒锤线) [268515]","IP6-CH1":"PL2 IP6(倒锤线) [268515]","IP6-CH2":"PL2 IP6(倒锤线) [268515]",IP1监测点:"IP1",IP1_CH1监测点:"IP1-CH1",IP1_CH2监测点:"IP1-CH2",IP2监测点:"IP2",IP2_CH1监测点:"IP2-CH1",IP2_CH2监测点:"IP2-CH2",IP3监测点:"IP3",IP3_CH1监测点:"IP3-CH1",IP3_CH2监测点:"IP3-CH2","EX1-2监测点":"EX1-2","EX1-3监测点":"EX1-3","EX1-4监测点":"EX1-4","EX1-5监测点":"EX1-5","EX1-6监测点":"EX1-6","EX1-7监测点":"EX1-7","EX1-8监测点":"EX1-8","EX1-9监测点":"EX1-9","EX1-10监测点":"EX1-10",上游水位监测点:"上游",下游水位监测点:"下游","组合窗 - 三层单列(固定 上悬) 单扇窗 [330274]":"IP1-CH1","挡水坝段4-4 挡水坝段4-4 [214417]":"EX1-2","基本墙 常规 - 200mm [328370]":"TC1-1","DL DL6 [316956]":"IP2-CH1","P Pxdb5-7 [310149]":"EX2-2"};function It(A){if(ee[A])return ee[A];const P=A.toLowerCase().replace(/[_\s]/g,"");for(const[w,F]of Object.entries(ee)){const g=w.toLowerCase().replace(/[_\s]/g,"");if(g.includes(P)||P.includes(g))return F}const $=[/IP\d+/i,/EX\d+-\d+/i,/TC\d+-\d+/i,/上游/i,/下游/i];for(const w of $){const F=A.match(w);if(F){const g=Object.values(ee).find(me=>me.toLowerCase().includes(F[0].toLowerCase()));if(g)return g}}return null}function Lt(A){const P=[];for(const[$,w]of Object.entries(ee))w===A&&P.push($);if(P.length===0){const $=A.toLowerCase().replace(/[-\s]/g,"");for(const[w,F]of Object.entries(ee)){const g=F.toLowerCase().replace(/[-\s]/g,"");(g.includes($.substring(0,3))||$.includes(g.substring(0,3)))&&P.push(w)}}return[...new Set(P)]}const Pt={class:"top-bar"},$t={class:"user-section"},Mt={class:"user-info"},Tt={class:"user-details"},kt={class:"username"},Xt={class:"user-role"},zt={class:"time-display"},Dt={class:"current-time"},At={class:"current-date"},Ft={class:"window-header"},Vt={class:"window-controls"},Bt={class:"window-content"},Nt={class:"stats-grid"},Ht={class:"stat-item"},Ot={class:"stat-item"},Rt={class:"stat-item"},Gt={class:"stat-item"},Ut={class:"monitoring-types"},jt={class:"additional-charts"},Wt={class:"chart-section"},Yt={class:"chart-header"},Kt={class:"chart-controls"},qt={class:"chart-section"},Jt={class:"chart-header"},Qt={class:"chart-controls"},Zt={class:"window-header"},el={class:"window-controls"},tl={class:"window-content"},ll={class:"points-list"},ol=["onClick"],nl={class:"point-info"},al={class:"point-name"},sl={class:"point-details"},il={class:"point-type"},rl={class:"point-instrument"},cl={class:"point-value"},ul={class:"value"},dl={class:"unit"},ml={key:0,class:"point-detail"},fl={class:"dynamic-chart"},vl={class:"chart-header"},_l={class:"chart-controls"},pl={class:"dynamic-chart"},hl={class:"historical-data-section"},yl={class:"section-header"},gl={class:"section-controls"},bl={class:"measurements-table"},xl={class:"table-footer"},wl={class:"window-header"},Cl={class:"window-controls"},Sl={class:"window-content"},El={class:"scroll-board-container"},Il={class:"window-header"},Ll={class:"window-controls"},Pl={class:"window-content"},$l={class:"model-controls"},Ml={class:"model-info"},Tl={class:"info-item"},kl={class:"value"},Xl={class:"info-item"},zl={class:"value"},Dl={key:0,class:"block-interaction-info"},Al={class:"info-section"},Fl={class:"info-item"},Vl={class:"info-item"},Bl={key:0,class:"info-item"},Nl={class:"value instrument-id"},Hl={__name:"Monitor",setup(A){const P=bt(),$=u(null),w=u({}),F=Ue(()=>`https://api.dicebear.com/7.x/avataaars/svg?seed=${w.value.username||"user"}`),g=u("dam1"),me={dam1:"大坝模型1",dam2:"大坝模型2",dam3:"大坝模型3"},Je={dam1:"GLB格式",dam2:"GLB格式",dam3:"GLB格式"},O=u({}),Ee=u([]),W=u([]),Qe=u([]),ne=u("all"),Ie=u(null),V=u(null),ae=u([]),Le=u(!1),Y=u(!1),K=u(!1),q=u(!1),J=u(!1),R=u("2024"),G=u("2024"),M=u("month"),fe=u(null),ve=u(null),_e=u(null),pe=u(null);let k=null,X=null,B=null,N=null;const Pe=u(""),$e=u(""),he=U({number:[0],content:"{nt}",style:{fontSize:24,fill:"#fff",fontWeight:"bold"},formatter:l=>l.toLocaleString()}),ye=U({number:[0],content:"{nt}",style:{fontSize:24,fill:"#fff",fontWeight:"bold"}}),ge=U({number:[0],content:"{nt}",style:{fontSize:24,fill:"#fff",fontWeight:"bold"}}),Ze=U({number:[0],content:"{nt}",style:{fontSize:18,fill:"#fff",fontWeight:"bold"},formatter:l=>"2024-2025"}),be=U({data:[],digitalFlopStyle:{fontSize:14},color:["#5B8FF9","#5AD8A6","#F6BD16","#6F5EF9","#E86452","#945FB9","#FF9845","#1E9493"],showOriginValue:!0}),Me=U({data:[],rowNum:5,waitTime:3e3,carousel:"single",unit:"mm"}),Te=U({data:[],header:["测量时间","监测类型","仪器编号","测量值"],headerBGC:"rgba(11, 25, 55, 0.9)",oddRowBGC:"rgba(11, 25, 55, 0.7)",evenRowBGC:"rgba(16, 36, 78, 0.7)",headerHeight:40,rowNum:5,columnWidth:[120,80,70,70],align:["center","center","center","center"]});let p=null,T=null,ke=new Map;const Q=u(""),te=u(""),xe=u(""),Z=u("");let le=null,oe=null;const et=Ue(()=>ne.value==="all"?W.value:W.value.filter(l=>l.type_id==ne.value)),Xe=()=>{const l=new Date;Pe.value=l.toLocaleTimeString("zh-CN"),$e.value=l.toLocaleDateString("zh-CN",{year:"numeric",month:"long",day:"numeric",weekday:"long"})},tt=()=>{P.push("/admin")},lt=async()=>{try{await xt(),P.push("/login")}catch(l){console.error("登出失败:",l)}},ot=async()=>{try{await Promise.all([ze(),De(),Ae(),Fe()]),z.success("数据已刷新")}catch(l){console.error("刷新数据失败:",l),z.error("刷新数据失败")}},ze=async()=>{try{O.value=await wt(),he.number=[O.value.total_measurements||0],ye.number=[O.value.instrument_count||0];const l=O.value.type_statistics?O.value.type_statistics.length:0;ge.number=[l],O.value.type_statistics&&(be.data=O.value.type_statistics.map(e=>({name:e.name,value:e.count})))}catch(l){console.error("加载统计数据失败:",l),he.number=[0],ye.number=[0],ge.number=[0],be.data=[]}},De=async()=>{try{Ee.value=await Ct()}catch(l){console.error("加载监测类型失败:",l)}},Ae=async()=>{try{const l=await St(),e=[];for(const o of l)try{const n=await H({instrument_id:o.instrument_id,limit:1,order_by:"measure_time desc"});e.push({id:e.length+1,instrument_id:o.instrument_id,name:`仪器 ${o.instrument_id}`,type_id:o.type_id,type_name:o.type_name,latest_value:n.length>0?n[0].value:null,unit:o.unit||"mm"})}catch(n){console.error(`获取仪器 ${o.instrument_id} 最新数据失败:`,n),e.push({id:e.length+1,instrument_id:o.instrument_id,name:`仪器 ${o.instrument_id}`,type_id:o.type_id,type_name:o.type_name,latest_value:null,unit:o.unit||"mm"})}W.value=e}catch(l){console.error("加载仪器列表失败:",l)}},Fe=async()=>{try{const l=await H({limit:10});Qe.value=l,Te.data=l.map(e=>[e.measure_time,e.type_name,e.instrument_id,`${e.value.toFixed(2)} ${e.unit}`])}catch(l){console.error("加载最新数据失败:",l)}},nt=async l=>{try{const e=W.value.find(n=>n.instrument_id===l);if(!e)return;const o=await H({instrument_id:e.instrument_id,limit:20});ae.value=o,Me.data=o.slice(0,5).map((n,m)=>({name:`测量${m+1}`,value:n.value.toFixed(2)})),await Ye(),Ve(e.instrument_id)}catch(e){console.error("加载测点数据失败:",e),ae.value=[],Me.data=[];const o=W.value.find(n=>n.instrument_id===l);o&&(await Ye(),Ve(o.instrument_id))}},Ve=l=>{_e.value&&(B&&B.dispose(),B=ue(_e.value),Be(l)),pe.value&&(N&&N.dispose(),N=ue(pe.value),at(l))},at=async l=>{if(N)try{const e=["2018","2019","2020","2021","2022","2023","2024"],o={};e.forEach(i=>{o[i]=0});for(const i of e)try{const f=`${i}-01-01 00:00:00`,s=`${i}-12-31 23:59:59`,d=await H({instrument_id:l,start_time:f,end_time:s,limit:1e3});o[i]=d.length}catch(f){console.error(`获取${i}年数据失败:`,f),o[i]=0}const n=e.map(i=>o[i]),m=Math.max(...n);let r=100;m>0&&(m>100?r=Math.ceil(m*1.2):r=Math.ceil(m*1.1)),N.setOption({title:{text:"仪器使用记录（2018-2024年）",left:"center",textStyle:{fontSize:12,color:"#a0cfff"}},tooltip:{trigger:"axis",formatter:i=>{const f=i[0].name,s=i[0].value;return`${f}: ${s} 条记录`}},xAxis:{type:"category",data:e.map(i=>`${i}年`),axisLabel:{color:"#a0cfff"},axisLine:{lineStyle:{color:"rgba(64, 158, 255, 0.3)"}}},yAxis:{type:"value",name:"记录数量",nameTextStyle:{color:"#a0cfff"},axisLabel:{color:"#a0cfff"},axisLine:{lineStyle:{color:"rgba(64, 158, 255, 0.3)"}},splitLine:{lineStyle:{color:"rgba(64, 158, 255, 0.1)"}},min:0,max:r},series:[{name:"使用记录",type:"bar",data:n,itemStyle:{color:new de(0,0,0,1,[{offset:0,color:"#F6BD16"},{offset:1,color:"#E86452"}])},label:{show:!0,position:"top",formatter:"{c}",color:"#fff"}}],grid:{left:"10%",right:"10%",bottom:"15%",top:"20%",containLabel:!0}})}catch(e){console.error("加载仪器使用记录失败:",e),N.setOption({title:{text:"仪器使用记录（2018-2024年）",subtext:"数据加载失败",left:"center",textStyle:{fontSize:12,color:"#a0cfff"}},xAxis:{type:"category",data:[],axisLabel:{color:"#a0cfff"}},yAxis:{type:"value",name:"记录数量",nameTextStyle:{color:"#a0cfff"},min:0,max:100},series:[{name:"使用记录",type:"bar",data:[]}]})}},Be=async l=>{if(B)try{const e=new Date("2024-12-31"),o=new Date("2024-12-31");M.value==="month"?o.setDate(o.getDate()-30):o.setFullYear(o.getFullYear()-1);const n=o.toISOString().replace("T"," ").substring(0,19),m=e.toISOString().replace("T"," ").substring(0,19),r=await H({instrument_id:l,start_time:n,end_time:m,limit:100});if(!r||r.length===0){B.setOption({title:{text:M.value==="month"?"最新一个月数据趋势":"最近一年数据趋势",subtext:"暂无数据",left:"center",textStyle:{fontSize:12,color:"#a0cfff"}},xAxis:{type:"category",data:[],axisLabel:{color:"#a0cfff"}},yAxis:{type:"value",name:"测量值",nameTextStyle:{color:"#a0cfff"},min:0,max:100},series:[{name:"数据趋势",type:"line",data:[]}]});return}const i=[...r].sort((b,E)=>new Date(b.measure_time)-new Date(E.measure_time)),f=i.map(b=>{const E=new Date(b.measure_time);return M.value==="month"?`${E.getMonth()+1}/${E.getDate()}`:`${E.getMonth()+1}月`}),s=i.map(b=>parseFloat(b.value.toFixed(2))),d=s.filter(b=>!isNaN(b)),x=d.length>0?Math.min(...d):0,h=d.length>0?Math.max(...d):100;let S=0,L=100;if(d.length>0)if(x<0){const E=(h-x)*.1;S=Math.floor(x-E),L=Math.ceil(h+E)}else h<10?(S=0,L=Math.ceil(h*1.2)):h<100?(S=Math.floor(x*.8),L=Math.ceil(h*1.2)):(S=Math.floor(x*.9),L=Math.ceil(h*1.1));B.setOption({title:{text:M.value==="month"?"最新一个月数据趋势":"最近一年数据趋势",left:"center",textStyle:{fontSize:12,color:"#a0cfff"}},tooltip:{trigger:"axis",formatter:b=>{var Se;const E=b[0].name,we=b[0].value,c=b[0].dataIndex;return`${((Se=i[c])==null?void 0:Se.measure_time)||E}: ${we}`}},xAxis:{type:"category",data:f,axisLabel:{color:"#a0cfff",rotate:M.value==="month"?45:0},axisLine:{lineStyle:{color:"rgba(64, 158, 255, 0.3)"}}},yAxis:{type:"value",name:"测量值",nameTextStyle:{color:"#a0cfff"},axisLabel:{color:"#a0cfff"},axisLine:{lineStyle:{color:"rgba(64, 158, 255, 0.3)"}},splitLine:{lineStyle:{color:"rgba(64, 158, 255, 0.1)"}},min:S,max:L},series:[{name:"数据趋势",type:"line",data:s,smooth:!0,itemStyle:{color:"#6F5EF9"},lineStyle:{width:2},areaStyle:{color:new de(0,0,0,1,[{offset:0,color:"rgba(111, 94, 249, 0.6)"},{offset:1,color:"rgba(111, 94, 249, 0.1)"}])}}],grid:{left:"10%",right:"10%",bottom:M.value==="month"?"20%":"15%",top:"20%",containLabel:!0}})}catch{B.setOption({title:{text:M.value==="month"?"最新一个月数据趋势":"最近一年数据趋势",subtext:"数据加载失败",left:"center",textStyle:{fontSize:12,color:"#a0cfff"}},xAxis:{type:"category",data:[],axisLabel:{color:"#a0cfff"}},yAxis:{type:"value",name:"测量值",nameTextStyle:{color:"#a0cfff"},min:0,max:100},series:[{name:"数据趋势",type:"line",data:[]}]})}},Ne=l=>{Ie.value=l.id,V.value=l,nt(l.instrument_id);const e=Lt(l.instrument_id);if(e.length>0&&g.value==="dam3"){const o=e[0];ct(o)}else se(),Z.value=""},st=()=>{$.value&&(p=new Cesium.Viewer($.value,{animation:!1,timeline:!1,baseLayerPicker:!1,geocoder:!1,homeButton:!1,sceneModePicker:!1,navigationHelpButton:!1,fullscreenButton:!1,selectionIndicator:!1,infoBox:!1,terrainProvider:new Cesium.EllipsoidTerrainProvider,imageryProvider:new Cesium.UrlTemplateImageryProvider({url:"https://tile.openstreetmap.org/{z}/{x}/{y}.png"})}),p.camera.setView({destination:Cesium.Cartesian3.fromDegrees(118.746,32.06,1e3),orientation:{heading:Cesium.Math.toRadians(0),pitch:Cesium.Math.toRadians(-45),roll:0}}),He(),ut())},He=()=>{if(!p)return;T&&(p.entities.remove(T),T=null);const l=Cesium.Cartesian3.fromDegrees(118.746,32.06,30);let e="/models/dam1.glb";g.value==="dam2"?e="/models/dam2.glb":g.value==="dam3"&&(e="/models/dam3.glb"),T=p.entities.add({position:l,model:{uri:e,scale:5,minimumPixelSize:128,maximumScale:100}}),p.zoomTo(T),g.value==="dam3"?setTimeout(()=>{it()},1e3):Oe()},it=()=>{!p||!T||(Oe(),rt())},rt=()=>{le=new Cesium.ScreenSpaceEventHandler(p.scene.canvas),le.setInputAction(l=>{const e=p.scene.pick(l.endPosition);if(Cesium.defined(e)&&e.detail&&e.detail.node){const o=e.detail.node._name||e.detail.node.name;if(o){const n=String(o);Q.value=n}else Q.value="模型表面"}else Q.value=""},Cesium.ScreenSpaceEventType.MOUSE_MOVE),oe=new Cesium.ScreenSpaceEventHandler(p.scene.canvas),oe.setInputAction(l=>{const e=p.scene.pick(l.position);if(Cesium.defined(e)&&e.detail&&e.detail.node){const o=e.detail.node._name||e.detail.node.name;if(o){const n=String(o);te.value=n;const m=It(n);if(xe.value=m,m){const r=W.value.find(i=>i.instrument_id===m);r?(Ne(r),z.success(`已选择分块: ${n} → 仪器: ${m}`)):z.warning(`找到分块: ${n}，但未找到对应的测点仪器: ${m}`)}else z.warning(`找到分块: ${n}，但未找到对应的仪器映射`)}else te.value="点击了模型表面",z.info("点击了模型表面，请尝试点击模型的不同部分")}else te.value="点击了模型表面",z.info("点击了模型表面，请尝试点击模型的不同部分")},Cesium.ScreenSpaceEventType.LEFT_CLICK)},Oe=()=>{le&&(le.destroy(),le=null),oe&&(oe.destroy(),oe=null),Q.value=""},ct=l=>{if(!p||!T)return;const e=T.model;if(!e||!e._runtime||!e._runtime._model)return;const o=e._runtime._model;if(!l||Z.value===l){se(),Z.value="";return}Z.value=l;try{if(o.silhouetteSize=5,o.silhouetteColor=Cesium.Color.YELLOW,p.scene.globe.depthTestAgainstTerrain=!1,o.style){const n=new Cesium.Cesium3DTileStyle({color:{conditions:[[`\${name} === '${l}'`,"color('lime')"],["true","color('rgba(128, 128, 128, 0.3)')"]]}});o.style=n}else if(o._sceneGraph&&o._sceneGraph._runtimeNodes){const n=o._sceneGraph._runtimeNodes;let m=!1;for(const r of n){const i=r._name||r.name;if(i)if(i===l)try{r.color=Cesium.Color.LIME,m=!0}catch(f){console.warn("无法设置节点颜色:",f)}else try{r.color=Cesium.Color.GRAY.withAlpha(.3)}catch{}}m||(console.warn(`未找到组件: ${l}`),se(),Z.value="")}}catch(n){console.error("高亮组件失败:",n),se(),Z.value=""}},se=()=>{if(!p||!T)return;const l=T.model;if(!l||!l._runtime||!l._runtime._model)return;const e=l._runtime._model;try{if(e.silhouetteSize=0,p.scene.globe.depthTestAgainstTerrain=!0,e.style&&(e.style=new Cesium.Cesium3DTileStyle({color:"color('white')"})),e._sceneGraph&&e._sceneGraph._runtimeNodes){const o=e._sceneGraph._runtimeNodes;for(const n of o)try{n.color=Cesium.Color.WHITE}catch{}}}catch(o){console.error("重置高亮失败:",o)}},ut=()=>{if(p){for(const l of ke.values())p.entities.remove(l);ke.clear()}},dt=()=>{p&&p.camera.setView({destination:Cesium.Cartesian3.fromDegrees(118.746,32.06,1e3),orientation:{heading:Cesium.Math.toRadians(0),pitch:Cesium.Math.toRadians(-45),roll:0}})},mt=()=>{const l=document.querySelector(".monitor-container");document.fullscreenElement?document.exitFullscreen():l.requestFullscreen().catch(e=>{console.error("全屏失败:",e)})},Re=async()=>{if(k)try{const l=parseInt(R.value),e=["1月","2月","3月","4月","5月","6月","7月","8月","9月","10月","11月","12月"],o={};e.forEach(s=>{o[s]={sum:0,count:0}});for(let s=1;s<=12;s++)try{const d=`${l}-${String(s).padStart(2,"0")}-01 00:00:00`,x=`${l}-${String(s).padStart(2,"0")}-31 23:59:59`,h=await H({type_id:3,instrument_id:"上游",start_time:d,end_time:x,limit:100});if(h.length>0){const S=`${s}月`;o[S].sum=h.reduce((L,b)=>L+b.value,0),o[S].count=h.length}}catch(d){console.error(`获取${l}年${s}月上游水位数据失败:`,d)}const n=e.map(s=>{if(o[s].count>0){const d=o[s].sum/o[s].count;return parseFloat(d.toFixed(2))}return null});if(!n.some(s=>s!==null)){k.setOption({title:{text:`上游水位变化 (${R.value})`,subtext:"暂无数据",left:"center",textStyle:{fontSize:12,color:"#a0cfff"}},xAxis:{type:"category",data:e,axisLabel:{color:"#a0cfff"}},yAxis:{type:"value",name:"水位 (m)",nameTextStyle:{color:"#a0cfff"},min:130,max:150},series:[{name:"上游水位",type:"line",data:n,connectNulls:!0}]});return}const r=n.filter(s=>s!==null&&!isNaN(s)),i=r.length>0?Math.min(...r):130,f=r.length>0?Math.max(...r):150;k.setOption({title:{text:`上游水位变化 (${R.value})`,left:"center",textStyle:{fontSize:12,color:"#a0cfff"}},tooltip:{trigger:"axis",formatter:s=>{const d=s[0].name,x=s[0].value;return x!==null?`${d}: ${x} m`:`${d}: 无数据`}},xAxis:{type:"category",data:e,axisLabel:{color:"#a0cfff"},axisLine:{lineStyle:{color:"rgba(64, 158, 255, 0.3)"}}},yAxis:{type:"value",name:"水位 (m)",nameTextStyle:{color:"#a0cfff"},axisLabel:{color:"#a0cfff"},axisLine:{lineStyle:{color:"rgba(64, 158, 255, 0.3)"}},splitLine:{lineStyle:{color:"rgba(64, 158, 255, 0.1)"}},min:Math.floor(i*.95),max:Math.ceil(f*1.05)},series:[{name:"上游水位",type:"line",data:n,smooth:!0,itemStyle:{color:"#5B8FF9"},lineStyle:{width:3},areaStyle:{color:new de(0,0,0,1,[{offset:0,color:"rgba(91, 143, 249, 0.6)"},{offset:1,color:"rgba(91, 143, 249, 0.1)"}])},connectNulls:!0}],grid:{left:"10%",right:"10%",bottom:"15%",top:"20%",containLabel:!0}})}catch(l){console.error("加载上游水位数据失败:",l);const e=["1月","2月","3月","4月","5月","6月","7月","8月","9月","10月","11月","12月"];k.setOption({title:{text:`上游水位变化 (${R.value})`,subtext:"数据加载失败",left:"center",textStyle:{fontSize:12,color:"#a0cfff"}},xAxis:{type:"category",data:e,axisLabel:{color:"#a0cfff"}},yAxis:{type:"value",name:"水位 (m)",nameTextStyle:{color:"#a0cfff"},min:130,max:150},series:[{name:"上游水位",type:"line",data:[]}]})}},Ge=async()=>{if(X)try{const l=parseInt(G.value),e=["1月","2月","3月","4月","5月","6月","7月","8月","9月","10月","11月","12月"],o={};e.forEach(s=>{o[s]={sum:0,count:0}});for(let s=1;s<=12;s++)try{const d=`${l}-${String(s).padStart(2,"0")}-01 00:00:00`,x=`${l}-${String(s).padStart(2,"0")}-31 23:59:59`,h=await H({type_id:3,instrument_id:"下游",start_time:d,end_time:x,limit:100});if(h.length>0){const S=`${s}月`;o[S].sum=h.reduce((L,b)=>L+b.value,0),o[S].count=h.length}}catch(d){console.error(`获取${l}年${s}月下游水位数据失败:`,d)}const n=e.map(s=>{if(o[s].count>0){const d=o[s].sum/o[s].count;return parseFloat(d.toFixed(2))}return null});if(!n.some(s=>s!==null)){X.setOption({title:{text:`下游水位变化 (${G.value})`,subtext:"暂无数据",left:"center",textStyle:{fontSize:12,color:"#a0cfff"}},xAxis:{type:"category",data:e,axisLabel:{color:"#a0cfff"}},yAxis:{type:"value",name:"水位 (m)",nameTextStyle:{color:"#a0cfff"},min:120,max:140},series:[{name:"下游水位",type:"line",data:n,connectNulls:!0}]});return}const r=n.filter(s=>s!==null&&!isNaN(s)),i=r.length>0?Math.min(...r):120,f=r.length>0?Math.max(...r):140;X.setOption({title:{text:`下游水位变化 (${G.value})`,left:"center",textStyle:{fontSize:12,color:"#a0cfff"}},tooltip:{trigger:"axis",formatter:s=>{const d=s[0].name,x=s[0].value;return x!==null?`${d}: ${x} m`:`${d}: 无数据`}},xAxis:{type:"category",data:e,axisLabel:{color:"#a0cfff"},axisLine:{lineStyle:{color:"rgba(64, 158, 255, 0.3)"}}},yAxis:{type:"value",name:"水位 (m)",nameTextStyle:{color:"#a0cfff"},axisLabel:{color:"#a0cfff"},axisLine:{lineStyle:{color:"rgba(64, 158, 255, 0.3)"}},splitLine:{lineStyle:{color:"rgba(64, 158, 255, 0.1)"}},min:Math.floor(i*.95),max:Math.ceil(f*1.05)},series:[{name:"下游水位",type:"line",data:n,smooth:!0,itemStyle:{color:"#E86452"},lineStyle:{width:3},areaStyle:{color:new de(0,0,0,1,[{offset:0,color:"rgba(232, 100, 82, 0.6)"},{offset:1,color:"rgba(232, 100, 82, 0.1)"}])},connectNulls:!0}],grid:{left:"10%",right:"10%",bottom:"15%",top:"20%",containLabel:!0}})}catch(l){console.error("加载下游水位数据失败:",l);const e=["1月","2月","3月","4月","5月","6月","7月","8月","9月","10月","11月","12月"];X.setOption({title:{text:`下游水位变化 (${G.value})`,subtext:"数据加载失败",left:"center",textStyle:{fontSize:12,color:"#a0cfff"}},xAxis:{type:"category",data:e,axisLabel:{color:"#a0cfff"}},yAxis:{type:"value",name:"水位 (m)",nameTextStyle:{color:"#a0cfff"},min:120,max:140},series:[{name:"下游水位",type:"line",data:[]}]})}};je([R,G],()=>{Re(),Ge()}),je(M,()=>{V.value&&B&&Be(V.value.instrument_id)});const ft=()=>{fe.value&&(k&&k.dispose(),k=ue(fe.value),Re()),ve.value&&(X&&X.dispose(),X=ue(ve.value),Ge())},vt=async()=>{if(V.value)try{const l=await H({instrument_id:V.value.instrument_id,limit:1e3}),n=[["测量时间","监测类型","仪器编号","测量值","单位","水位值"].join(","),...l.map(f=>[`"${f.measure_time}"`,`"${f.type_name}"`,`"${f.instrument_id}"`,f.value,`"${f.unit}"`,f.water_level||""].join(","))].join(`
`),m=new Blob([n],{type:"text/csv;charset=utf-8;"}),r=document.createElement("a"),i=URL.createObjectURL(m);r.setAttribute("href",i),r.setAttribute("download",`${V.value.name}_${V.value.instrument_id}_数据.csv`),r.style.visibility="hidden",document.body.appendChild(r),r.click(),document.body.removeChild(r),z.success("数据导出成功")}catch(l){console.error("导出数据失败:",l),z.error("导出数据失败")}};return _t(async()=>{try{w.value=await pt()}catch(e){console.error("加载用户信息失败:",e);const o=localStorage.getItem("user_info");if(o)try{w.value=JSON.parse(o)}catch{w.value={username:"用户",role:"user"}}}Xe();const l=setInterval(Xe,1e3);await Promise.all([ze(),De(),Ae(),Fe()]),st(),ft(),document.addEventListener("fullscreenchange",()=>{Le.value=!!document.fullscreenElement}),ht(()=>{clearInterval(l),p&&p.destroy(),k&&k.dispose(),X&&X.dispose(),N&&N.dispose(),monthlyTrendChart&&monthlyTrendChart.dispose(),document.removeEventListener("fullscreenchange",()=>{})})}),(l,e)=>{const o=C("el-avatar"),n=C("el-button"),m=C("dv-digital-flop"),r=C("dv-active-ring-chart"),i=C("el-option"),f=C("el-select"),s=C("dv-border-box-8"),d=C("el-radio-button"),x=C("el-radio-group"),h=C("el-table-column"),S=C("el-table"),L=C("dv-border-box-10"),b=C("dv-scroll-board"),E=C("dv-border-box-12"),we=C("dv-border-box-13");return D(),j("div",{class:I(["monitor-container",{fullscreen:Le.value}])},[t("div",{ref_key:"viewerEl",ref:$,class:"cesium-viewer"},null,512),t("div",Pt,[e[11]||(e[11]=t("div",{class:"title-section"},[t("h1",null,"智慧水利大坝安全监测平台"),t("p",{class:"subtitle"},"实时监测 · 三维可视化 · 数据分析")],-1)),t("div",$t,[t("div",Mt,[a(o,{size:36,src:F.value},null,8,["src"]),t("div",Tt,[t("div",kt,_(w.value.name||w.value.username),1),t("div",Xt,_(w.value.role==="admin"?"管理员":"普通用户"),1)]),yt(gt)?(D(),We(n,{key:0,type:"primary",size:"small",onClick:tt},{default:v(()=>[...e[9]||(e[9]=[y("后台管理",-1)])]),_:1})):ie("",!0),a(n,{size:"small",onClick:lt},{default:v(()=>[...e[10]||(e[10]=[y("退出",-1)])]),_:1})]),t("div",zt,[t("div",Dt,_(Pe.value),1),t("div",At,_($e.value),1)])])]),a(s,{class:I(["floating-window left-window overview-window",{collapsed:Y.value}])},{default:v(()=>[t("div",Ft,[e[13]||(e[13]=t("h3",null,[t("i",{class:"el-icon-monitor"}),y(" 监测概览")],-1)),t("div",Vt,[a(n,{size:"small",onClick:ot},{default:v(()=>[...e[12]||(e[12]=[t("i",{class:"el-icon-refresh"},null,-1),y(" 刷新 ",-1)])]),_:1}),a(n,{size:"small",onClick:e[0]||(e[0]=c=>Y.value=!Y.value)},{default:v(()=>[t("i",{class:I(Y.value?"el-icon-full-screen":"el-icon-crop")},null,2),y(" "+_(Y.value?"展开":"收起"),1)]),_:1})])]),re(t("div",Bt,[t("div",Nt,[t("div",Ht,[a(m,{config:he},null,8,["config"]),e[14]||(e[14]=t("div",{class:"stat-label"},"总测量记录",-1))]),t("div",Ot,[a(m,{config:ye},null,8,["config"]),e[15]||(e[15]=t("div",{class:"stat-label"},"监测仪器",-1))]),t("div",Rt,[a(m,{config:ge},null,8,["config"]),e[16]||(e[16]=t("div",{class:"stat-label"},"监测类型",-1))]),t("div",Gt,[a(m,{config:Ze},null,8,["config"]),e[17]||(e[17]=t("div",{class:"stat-label"},"最新数据年度",-1))])]),t("div",Ut,[e[18]||(e[18]=t("h4",null,"监测类型分布",-1)),a(r,{config:be,class:"chart-container"},null,8,["config"])]),t("div",jt,[t("div",Wt,[t("div",Yt,[e[19]||(e[19]=t("h4",null,"上游水位变化趋势",-1)),t("div",Kt,[a(f,{modelValue:R.value,"onUpdate:modelValue":e[1]||(e[1]=c=>R.value=c),placeholder:"年份",size:"small",style:{width:"100px"}},{default:v(()=>[a(i,{label:"2018",value:"2018"}),a(i,{label:"2019",value:"2019"}),a(i,{label:"2020",value:"2020"}),a(i,{label:"2021",value:"2021"}),a(i,{label:"2022",value:"2022"}),a(i,{label:"2023",value:"2023"}),a(i,{label:"2024",value:"2024"})]),_:1},8,["modelValue"])])]),t("div",{ref_key:"upstreamChartEl",ref:fe,class:"chart-container"},null,512)]),t("div",qt,[t("div",Jt,[e[20]||(e[20]=t("h4",null,"下游水位变化趋势",-1)),t("div",Qt,[a(f,{modelValue:G.value,"onUpdate:modelValue":e[2]||(e[2]=c=>G.value=c),placeholder:"年份",size:"small",style:{width:"100px"}},{default:v(()=>[a(i,{label:"2018",value:"2018"}),a(i,{label:"2019",value:"2019"}),a(i,{label:"2020",value:"2020"}),a(i,{label:"2021",value:"2021"}),a(i,{label:"2022",value:"2022"}),a(i,{label:"2023",value:"2023"}),a(i,{label:"2024",value:"2024"})]),_:1},8,["modelValue"])])]),t("div",{ref_key:"downstreamChartEl",ref:ve,class:"chart-container"},null,512)])])],512),[[ce,!Y.value]])]),_:1},8,["class"]),a(L,{class:I(["floating-window right-window points-window",{collapsed:K.value}])},{default:v(()=>[t("div",Zt,[e[21]||(e[21]=t("h3",null,[t("i",{class:"el-icon-location-information"}),y(" 测点数据")],-1)),t("div",el,[a(f,{modelValue:ne.value,"onUpdate:modelValue":e[3]||(e[3]=c=>ne.value=c),placeholder:"类型筛选",size:"small",style:{width:"100px"}},{default:v(()=>[a(i,{label:"全部",value:"all"}),(D(!0),j(Ke,null,qe(Ee.value,c=>(D(),We(i,{key:c.id,label:c.name,value:c.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),a(n,{size:"small",onClick:e[4]||(e[4]=c=>K.value=!K.value)},{default:v(()=>[t("i",{class:I(K.value?"el-icon-full-screen":"el-icon-crop")},null,2),y(" "+_(K.value?"展开":"收起"),1)]),_:1})])]),re(t("div",tl,[t("div",ll,[(D(!0),j(Ke,null,qe(et.value,c=>{var Ce;return D(),j("div",{key:c.id,class:I(["point-item",{active:Ie.value===c.id}]),onClick:Se=>Ne(c)},[t("div",nl,[t("div",al,_(c.name),1),t("div",sl,[t("span",il,_(c.type_name),1),t("span",rl,"仪器: "+_(c.instrument_id),1)])]),t("div",cl,[t("div",ul,_(((Ce=c.latest_value)==null?void 0:Ce.toFixed(2))||"--"),1),t("div",dl,_(c.unit||""),1)])],10,ol)}),128))]),V.value?(D(),j("div",ml,[t("div",fl,[t("div",vl,[e[24]||(e[24]=t("h4",null,"最新数据趋势",-1)),t("div",_l,[a(x,{modelValue:M.value,"onUpdate:modelValue":e[5]||(e[5]=c=>M.value=c),size:"small"},{default:v(()=>[a(d,{label:"month"},{default:v(()=>[...e[22]||(e[22]=[y("一个月",-1)])]),_:1}),a(d,{label:"year"},{default:v(()=>[...e[23]||(e[23]=[y("一年",-1)])]),_:1})]),_:1},8,["modelValue"])])]),t("div",{ref_key:"trendChartEl",ref:_e,class:"chart-container",style:{height:"200px"}},null,512)]),t("div",pl,[e[25]||(e[25]=t("div",{class:"chart-header"},[t("h4",null,"仪器使用记录（2018-2024年）")],-1)),t("div",{ref_key:"usageChartEl",ref:pe,class:"chart-container",style:{height:"200px"}},null,512)]),t("div",hl,[t("div",yl,[e[27]||(e[27]=t("h4",null,"历史数据",-1)),t("div",gl,[a(n,{size:"small",onClick:vt,type:"primary"},{default:v(()=>[...e[26]||(e[26]=[t("i",{class:"el-icon-download"},null,-1),y(" 导出CSV ",-1)])]),_:1})])]),t("div",bl,[a(S,{data:ae.value,size:"small",height:"200"},{default:v(()=>[a(h,{prop:"measure_time",label:"测量时间",width:"150"}),a(h,{prop:"type_name",label:"监测类型",width:"100"}),a(h,{prop:"instrument_id",label:"仪器编号",width:"100"}),a(h,{prop:"value",label:"测量值",width:"100"},{default:v(({row:c})=>[y(_(c.value.toFixed(2))+" "+_(c.unit),1)]),_:1}),a(h,{prop:"water_level",label:"水位值",width:"100"},{default:v(({row:c})=>[y(_(c.water_level?c.water_level.toFixed(2):"--"),1)]),_:1})]),_:1},8,["data"]),t("div",xl," 共 "+_(ae.value.length)+" 条记录，显示最近20条 ",1)])])])):ie("",!0)],512),[[ce,!K.value]])]),_:1},8,["class"]),a(E,{class:I(["floating-window bottom-window latest-data-window",{collapsed:q.value}])},{default:v(()=>[t("div",wl,[e[28]||(e[28]=t("h3",null,[t("i",{class:"el-icon-s-data"}),y(" 最新监测数据")],-1)),t("div",Cl,[a(n,{size:"small",onClick:e[6]||(e[6]=c=>q.value=!q.value)},{default:v(()=>[t("i",{class:I(q.value?"el-icon-full-screen":"el-icon-crop")},null,2),y(" "+_(q.value?"展开":"收起"),1)]),_:1})])]),re(t("div",Sl,[t("div",El,[a(b,{config:Te},null,8,["config"])])],512),[[ce,!q.value]])]),_:1},8,["class"]),a(we,{class:I(["floating-window model-control-window",{collapsed:J.value}])},{default:v(()=>[t("div",Il,[e[29]||(e[29]=t("h3",null,[t("i",{class:"el-icon-map-location"}),y(" 模型控制")],-1)),t("div",Ll,[a(n,{size:"small",onClick:e[7]||(e[7]=c=>J.value=!J.value)},{default:v(()=>[t("i",{class:I(J.value?"el-icon-full-screen":"el-icon-crop")},null,2),y(" "+_(J.value?"展开":"收起"),1)]),_:1})])]),re(t("div",Pl,[t("div",$l,[a(f,{modelValue:g.value,"onUpdate:modelValue":e[8]||(e[8]=c=>g.value=c),placeholder:"选择模型",size:"small",onChange:He},{default:v(()=>[a(i,{label:"大坝模型1 (dam1.glb)",value:"dam1"}),a(i,{label:"大坝模型2 (dam2.glb)",value:"dam2"}),a(i,{label:"大坝模型3 (dam3.glb)",value:"dam3"})]),_:1},8,["modelValue"]),a(n,{size:"small",onClick:dt},{default:v(()=>[...e[30]||(e[30]=[y("重置视角",-1)])]),_:1}),a(n,{size:"small",onClick:mt},{default:v(()=>[...e[31]||(e[31]=[t("i",{class:"el-icon-full-screen"},null,-1),y(" 全屏 ",-1)])]),_:1})]),t("div",Ml,[t("div",Tl,[e[32]||(e[32]=t("span",{class:"label"},"当前模型：",-1)),t("span",kl,_(me[g.value]),1)]),t("div",Xl,[e[33]||(e[33]=t("span",{class:"label"},"模型格式：",-1)),t("span",zl,_(Je[g.value]),1)])]),g.value==="dam3"?(D(),j("div",Dl,[t("div",Al,[e[37]||(e[37]=t("h4",null,[t("i",{class:"el-icon-mouse"}),y(" 分块交互")],-1)),t("div",Fl,[e[34]||(e[34]=t("span",{class:"label"},"悬停分块：",-1)),t("span",{class:I(["value",{highlight:Q.value}])},_(Q.value||"无"),3)]),t("div",Vl,[e[35]||(e[35]=t("span",{class:"label"},"选中分块：",-1)),t("span",{class:I(["value",{highlight:te.value}])},_(te.value||"无"),3)]),xe.value?(D(),j("div",Bl,[e[36]||(e[36]=t("span",{class:"label"},"对应仪器：",-1)),t("span",Nl,_(xe.value),1)])):ie("",!0),e[38]||(e[38]=t("div",{class:"interaction-hint"},[t("i",{class:"el-icon-info"}),y(" 提示：鼠标悬停可高亮分块，点击分块可查看对应测点数据 ")],-1))])])):ie("",!0)],512),[[ce,!J.value]])]),_:1},8,["class"])],2)}}},Ul=Et(Hl,[["__scopeId","data-v-167be942"]]);export{Ul as default};
