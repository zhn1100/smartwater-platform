import{r as v,m as je,a as R,n as Se,p as _t,q as ht,s as yt,c as G,b as t,d as i,t as We,v as re,e as S,x as h,f as gt,y as xt,w as p,z as I,E as D,A as Ye,u as bt,o as X,j as g,B as ce,C as ue,F as Ke,D as qe,G as wt}from"./index-DBatsnGE.js";import{g as Ct,a as St,b as Je,c as J,i as de,d as Ee,L as oe}from"./monitoring_new-DuXS4TZH.js";import{_ as Et}from"./_plugin-vue_export-helper-DlAUqK2U.js";const Q={"EX EX1 [239587]":"IP1","EX EX2 [239614]":"EX1-2","EX EX3 [239599]":"EX1-3","EX EX4 [239611]":"EX1-4","EX EX5 [239608]":"EX1-5","EX EX6 [239590]":"EX1-6","EX EX7 [239593]":"EX1-7","EX EX8 [239602]":"EX1-8","EX EX9 [239596]":"EX1-9","EX EX10 [239584]":"EX1-10","IP IP1 [257492]":"IP1","IP IP2 [253389]":"IP2","IP IP3 [257472]":"IP3","PL2 IP6(倒锤线) [268515]":"IP6-CH1",IP6:"PL2 IP6(倒锤线) [268515]","IP6-CH1":"PL2 IP6(倒锤线) [268515]","IP6-CH2":"PL2 IP6(倒锤线) [268515]",IP1监测点:"IP1",IP1_CH1监测点:"IP1-CH1",IP1_CH2监测点:"IP1-CH2",IP2监测点:"IP2",IP2_CH1监测点:"IP2-CH1",IP2_CH2监测点:"IP2-CH2",IP3监测点:"IP3",IP3_CH1监测点:"IP3-CH1",IP3_CH2监测点:"IP3-CH2","EX1-2监测点":"EX1-2","EX1-3监测点":"EX1-3","EX1-4监测点":"EX1-4","EX1-5监测点":"EX1-5","EX1-6监测点":"EX1-6","EX1-7监测点":"EX1-7","EX1-8监测点":"EX1-8","EX1-9监测点":"EX1-9","EX1-10监测点":"EX1-10",上游水位监测点:"上游",下游水位监测点:"下游","组合窗 - 三层单列(固定 上悬) 单扇窗 [330274]":"IP1-CH1","挡水坝段4-4 挡水坝段4-4 [214417]":"EX1-2","基本墙 常规 - 200mm [328370]":"TC1-1","DL DL6 [316956]":"IP2-CH1","P Pxdb5-7 [310149]":"EX2-2"};function It(A){if(Q[A])return Q[A];const M=A.toLowerCase().replace(/[_\s]/g,"");for(const[C,F]of Object.entries(Q)){const x=C.toLowerCase().replace(/[_\s]/g,"");if(x.includes(M)||M.includes(x))return F}const P=[/IP\d+/i,/EX\d+-\d+/i,/TC\d+-\d+/i,/上游/i,/下游/i];for(const C of P){const F=A.match(C);if(F){const x=Object.values(Q).find(me=>me.toLowerCase().includes(F[0].toLowerCase()));if(x)return x}}return null}function Lt(A){const M=[];for(const[P,C]of Object.entries(Q))C===A&&M.push(P);if(M.length===0){const P=A.toLowerCase().replace(/[-\s]/g,"");for(const[C,F]of Object.entries(Q)){const x=F.toLowerCase().replace(/[-\s]/g,"");(x.includes(P.substring(0,3))||P.includes(x.substring(0,3)))&&M.push(C)}}return[...new Set(M)]}const Mt={class:"top-bar"},Pt={class:"user-section"},zt={class:"user-info"},Tt={class:"user-details"},$t={class:"username"},kt={class:"user-role"},Dt={class:"time-display"},Xt={class:"current-time"},At={class:"current-date"},Ft={class:"window-header"},Vt={class:"window-controls"},Nt={class:"window-content"},Bt={class:"stats-grid"},Ot={class:"stat-item"},Ht={class:"stat-item"},Rt={class:"stat-item"},Gt={class:"stat-item"},Ut={class:"monitoring-types"},jt={class:"additional-charts"},Wt={class:"chart-section"},Yt={class:"chart-header"},Kt={class:"chart-controls"},qt={class:"chart-section"},Jt={class:"chart-header"},Qt={class:"chart-controls"},Zt={class:"window-header"},ea={class:"window-controls"},ta={class:"window-content"},aa={class:"points-list"},la=["onClick"],oa={class:"point-info"},na={class:"point-name"},sa={class:"point-details"},ia={class:"point-type"},ra={class:"point-instrument"},ca={class:"point-value"},ua={class:"value"},da={class:"unit"},ma={key:0,class:"point-detail"},fa={class:"dynamic-chart"},va={class:"chart-header"},pa={class:"chart-controls"},_a={class:"dynamic-chart"},ha={class:"historical-data-section"},ya={class:"section-header"},ga={class:"section-controls"},xa={class:"measurements-table"},ba={class:"table-footer"},wa={class:"window-header"},Ca={class:"window-controls"},Sa={class:"window-content"},Ea={class:"scroll-board-container"},Ia={class:"window-header"},La={class:"window-controls"},Ma={class:"window-content"},Pa={class:"model-controls"},za={class:"model-info"},Ta={class:"info-item"},$a={class:"value"},ka={class:"info-item"},Da={class:"value"},Xa={key:0,class:"block-interaction-info"},Aa={class:"info-section"},Fa={class:"info-item"},Va={class:"info-item"},Na={key:0,class:"info-item"},Ba={class:"value instrument-id"},Oa={__name:"Monitor",setup(A){const M=bt(),P=v(null),C=v({}),F=je(()=>`https://api.dicebear.com/7.x/avataaars/svg?seed=${C.value.username||"user"}`),x=v("dam1"),me={dam1:"大坝模型1",dam2:"大坝模型2",dam3:"大坝模型3"},Qe={dam1:"GLB格式",dam2:"GLB格式",dam3:"GLB格式"},B=v({}),Ie=v([]),T=v([]),Ze=v([]),ne=v("all"),Le=v(null),V=v(null),se=v([]),Me=v(!1),U=v(!1),j=v(!1),W=v(!1),Y=v(!1),O=v("2024"),H=v("2024"),Z=v("month"),fe=v(null),ve=v(null),pe=v(null),_e=v(null);let $=null,k=null,L=null,N=null;const Pe=v(""),ze=v(""),he=R({number:[0],content:"{nt}",style:{fontSize:24,fill:"#fff",fontWeight:"bold"},formatter:a=>a.toLocaleString()}),ye=R({number:[0],content:"{nt}",style:{fontSize:24,fill:"#fff",fontWeight:"bold"}}),ge=R({number:[0],content:"{nt}",style:{fontSize:24,fill:"#fff",fontWeight:"bold"}}),et=R({number:[0],content:"{nt}",style:{fontSize:18,fill:"#fff",fontWeight:"bold"},formatter:a=>"2024-2025"}),xe=R({data:[],digitalFlopStyle:{fontSize:14},color:["#5B8FF9","#5AD8A6","#F6BD16","#6F5EF9","#E86452","#945FB9","#FF9845","#1E9493"],showOriginValue:!0}),Te=R({data:[],rowNum:5,waitTime:3e3,carousel:"single",unit:"mm"}),$e=R({data:[],header:["测量时间","监测类型","仪器编号","测量值"],headerBGC:"rgba(11, 25, 55, 0.9)",oddRowBGC:"rgba(11, 25, 55, 0.7)",evenRowBGC:"rgba(16, 36, 78, 0.7)",headerHeight:40,rowNum:5,columnWidth:[120,80,70,70],align:["center","center","center","center"]});let y=null,z=null,ke=new Map;const K=v(""),ee=v(""),be=v(""),q=v("");let te=null,ae=null;const tt=je(()=>ne.value==="all"?T.value:T.value.filter(a=>a.type_id==ne.value)),De=()=>{const a=new Date;Pe.value=a.toLocaleTimeString("zh-CN"),ze.value=a.toLocaleDateString("zh-CN",{year:"numeric",month:"long",day:"numeric",weekday:"long"})},at=()=>{M.push("/admin")},lt=async()=>{try{await wt(),M.push("/login")}catch(a){console.error("登出失败:",a)}},ot=async()=>{try{await Promise.all([Xe(),Ae(),Fe(),Ve()]),D.success("数据已刷新")}catch(a){console.error("刷新数据失败:",a),D.error("刷新数据失败")}},Xe=async()=>{try{B.value=await Ct(),he.number=[B.value.total_measurements||0],ye.number=[B.value.instrument_count||0];const a=B.value.type_statistics?B.value.type_statistics.length:0;ge.number=[a],B.value.type_statistics&&(xe.data=B.value.type_statistics.map(e=>({name:e.name,value:e.count})))}catch(a){console.error("加载统计数据失败:",a),he.number=[0],ye.number=[0],ge.number=[0],xe.data=[]}},Ae=async()=>{try{Ie.value=await St()}catch(a){console.error("加载监测类型失败:",a)}},Fe=async()=>{try{const a=await Je(),e=await J({limit:250,order_by:"measure_time desc"}),l=new Map;a.forEach(r=>{l.set(r.instrument_id,{id:l.size+1,instrument_id:r.instrument_id,name:`仪器 ${r.instrument_id}`,type_id:r.type_id,type_name:r.type_name,latest_value:null,unit:r.unit||"mm"})});const o=new Set;for(const r of e){const u=r.instrument_id;if(!o.has(u)&&l.has(u)){const n=l.get(u);if(n.latest_value=r.value,o.add(u),o.size===l.size)break}}T.value=Array.from(l.values()),console.log(`加载了 ${T.value.length} 个仪器，其中 ${o.size} 个有最新数据`)}catch(a){console.error("加载仪器列表失败:",a);try{const e=await Je();T.value=e.map((l,o)=>({id:o+1,instrument_id:l.instrument_id,name:`仪器 ${l.instrument_id}`,type_id:l.type_id,type_name:l.type_name,latest_value:null,unit:l.unit||"mm"}))}catch(e){console.error("回退方法也失败:",e)}}},Ve=async()=>{try{const a=await J({limit:10});Ze.value=a,$e.data=a.map(e=>[e.measure_time,e.type_name,e.instrument_id,`${e.value.toFixed(2)} ${e.unit}`])}catch(a){console.error("加载最新数据失败:",a)}},nt=async a=>{try{const e=T.value.find(o=>o.instrument_id===a);if(!e)return;const l=await J({instrument_id:e.instrument_id,limit:20});se.value=l,Te.data=l.slice(0,5).map((o,r)=>({name:`测量${r+1}`,value:o.value.toFixed(2)})),await Ye(),Ne(e.instrument_id)}catch(e){console.error("加载测点数据失败:",e),se.value=[],Te.data=[];const l=T.value.find(o=>o.instrument_id===a);l&&(await Ye(),Ne(l.instrument_id))}},Ne=a=>{pe.value&&(L&&L.dispose(),L=de(pe.value),Be(a)),_e.value&&(N&&N.dispose(),N=de(_e.value),st(a))},st=async a=>{if(N)try{const e=T.value.find(c=>c.instrument_id===a),o=e&&(e.type_name==="水位"||e.instrument_id==="上游"||e.instrument_id==="下游")?2562:400,r=await J({instrument_id:a,limit:o,order_by:"measure_time desc"}),u=["2018","2019","2020","2021","2022","2023","2024"],n={};u.forEach(c=>{n[c]=0}),r.forEach(c=>{const b=new Date(c.measure_time).getFullYear().toString();n.hasOwnProperty(b)&&n[b]++});const m=u.map(c=>n[c]),_=Math.max(...m);let s=100;_>0&&(_>100?s=Math.ceil(_*1.2):s=Math.ceil(_*1.1)),N.setOption({title:{text:"仪器使用记录（2018-2024年）",left:"center",textStyle:{fontSize:12,color:"#a0cfff"}},tooltip:{trigger:"axis",formatter:c=>{const f=c[0].name,b=c[0].value;return`${f}: ${b} 条记录`}},xAxis:{type:"category",data:u.map(c=>`${c}年`),axisLabel:{color:"#a0cfff"},axisLine:{lineStyle:{color:"rgba(64, 158, 255, 0.3)"}}},yAxis:{type:"value",name:"记录数量",nameTextStyle:{color:"#a0cfff"},axisLabel:{color:"#a0cfff"},axisLine:{lineStyle:{color:"rgba(64, 158, 255, 0.3)"}},splitLine:{lineStyle:{color:"rgba(64, 158, 255, 0.1)"}},min:0,max:s},series:[{name:"使用记录",type:"bar",data:m,itemStyle:{color:new oe(0,0,0,1,[{offset:0,color:"#F6BD16"},{offset:1,color:"#E86452"}])},label:{show:!0,position:"top",formatter:"{c}",color:"#fff"}}],grid:{left:"10%",right:"10%",bottom:"15%",top:"20%",containLabel:!0}})}catch(e){console.error("加载仪器使用记录失败:",e),N.setOption({title:{text:"仪器使用记录（2018-2024年）",subtext:"数据加载失败",left:"center",textStyle:{fontSize:12,color:"#a0cfff"}},xAxis:{type:"category",data:[],axisLabel:{color:"#a0cfff"}},yAxis:{type:"value",name:"记录数量",nameTextStyle:{color:"#a0cfff"},min:0,max:100},series:[{name:"使用记录",type:"bar",data:[]}]})}},Be=async a=>{if(L)try{if(Z.value==="month"){const e=await J({instrument_id:a,limit:30,order_by:"measure_time desc"});if(!e||e.length===0){L.setOption({title:{text:"最新一个月数据趋势",subtext:"暂无数据",left:"center",textStyle:{fontSize:12,color:"#a0cfff"}},xAxis:{type:"category",data:[],axisLabel:{color:"#a0cfff"}},yAxis:{type:"value",name:"测量值",nameTextStyle:{color:"#a0cfff"},min:0,max:100},series:[{name:"数据趋势",type:"line",data:[]}]});return}const l=new Date(e[0].measure_time),o=new Date(l);o.setDate(l.getDate()-30);const r=e.filter(w=>new Date(w.measure_time)>=o);if(r.length===0){L.setOption({title:{text:"最新一个月数据趋势",subtext:"最近一个月内无数据",left:"center",textStyle:{fontSize:12,color:"#a0cfff"}},xAxis:{type:"category",data:[],axisLabel:{color:"#a0cfff"}},yAxis:{type:"value",name:"测量值",nameTextStyle:{color:"#a0cfff"},min:0,max:100},series:[{name:"数据趋势",type:"line",data:[]}]});return}const u=[...r].sort((w,E)=>new Date(w.measure_time)-new Date(E.measure_time)),n=u.map(w=>{const E=new Date(w.measure_time);return`${E.getMonth()+1}/${E.getDate()}`}),m=u.map(w=>parseFloat(w.value.toFixed(2))),_=m.filter(w=>!isNaN(w)),s=_.length>0?Math.min(..._):0,c=_.length>0?Math.max(..._):100;let f=0,b=100;if(_.length>0)if(s<0){const E=(c-s)*.1;f=Math.floor(s-E),b=Math.ceil(c+E)}else c<10?(f=0,b=Math.ceil(c*1.2)):c<100?(f=Math.floor(s*.8),b=Math.ceil(c*1.2)):(f=Math.floor(s*.9),b=Math.ceil(c*1.1));L.setOption({title:{text:"最新一个月数据趋势",left:"center",textStyle:{fontSize:12,color:"#a0cfff"}},tooltip:{trigger:"axis",formatter:w=>{var le;const E=w[0].name,we=w[0].value,Ce=w[0].dataIndex;return`${((le=u[Ce])==null?void 0:le.measure_time)||E}: ${we}`}},xAxis:{type:"category",data:n,axisLabel:{color:"#a0cfff",rotate:45},axisLine:{lineStyle:{color:"rgba(64, 158, 255, 0.3)"}}},yAxis:{type:"value",name:"测量值",nameTextStyle:{color:"#a0cfff"},axisLabel:{color:"#a0cfff"},axisLine:{lineStyle:{color:"rgba(64, 158, 255, 0.3)"}},splitLine:{lineStyle:{color:"rgba(64, 158, 255, 0.1)"}},min:f,max:b},series:[{name:"数据趋势",type:"line",data:m,smooth:!0,itemStyle:{color:"#6F5EF9"},lineStyle:{width:2},areaStyle:{color:new oe(0,0,0,1,[{offset:0,color:"rgba(111, 94, 249, 0.6)"},{offset:1,color:"rgba(111, 94, 249, 0.1)"}])}}],grid:{left:"10%",right:"10%",bottom:"20%",top:"20%",containLabel:!0}})}else{const e=await Ee({interval:"month",instrument_id:a,end_time:"2024-12-31 23:59:59",limit:12});if(!e||e.length===0){L.setOption({title:{text:"最近一年数据趋势",subtext:"暂无数据",left:"center",textStyle:{fontSize:12,color:"#a0cfff"}},xAxis:{type:"category",data:[],axisLabel:{color:"#a0cfff"}},yAxis:{type:"value",name:"测量值",nameTextStyle:{color:"#a0cfff"},min:0,max:100},series:[{name:"数据趋势",type:"line",data:[]}]});return}const l=e.map(s=>{const[c,f]=s.period.split("-");return`${parseInt(f)}月`}).reverse(),o=e.map(s=>s.avg_value).reverse(),r=o.filter(s=>s!==null&&!isNaN(s)),u=r.length>0?Math.min(...r):0,n=r.length>0?Math.max(...r):100;let m=0,_=100;if(r.length>0)if(u<0){const c=(n-u)*.1;m=Math.floor(u-c),_=Math.ceil(n+c)}else n<10?(m=0,_=Math.ceil(n*1.2)):n<100?(m=Math.floor(u*.8),_=Math.ceil(n*1.2)):(m=Math.floor(u*.9),_=Math.ceil(n*1.1));L.setOption({title:{text:"最近一年数据趋势",left:"center",textStyle:{fontSize:12,color:"#a0cfff"}},tooltip:{trigger:"axis",formatter:s=>{const c=s[0].name,f=s[0].value;return`${c}: ${f!==null?f.toFixed(2):"无数据"}`}},xAxis:{type:"category",data:l,axisLabel:{color:"#a0cfff"},axisLine:{lineStyle:{color:"rgba(64, 158, 255, 0.3)"}}},yAxis:{type:"value",name:"测量值",nameTextStyle:{color:"#a0cfff"},axisLabel:{color:"#a0cfff"},axisLine:{lineStyle:{color:"rgba(64, 158, 255, 0.3)"}},splitLine:{lineStyle:{color:"rgba(64, 158, 255, 0.1)"}},min:m,max:_},series:[{name:"数据趋势",type:"line",data:o,smooth:!0,itemStyle:{color:"#6F5EF9"},lineStyle:{width:2},areaStyle:{color:new oe(0,0,0,1,[{offset:0,color:"rgba(111, 94, 249, 0.6)"},{offset:1,color:"rgba(111, 94, 249, 0.1)"}])},connectNulls:!0}],grid:{left:"10%",right:"10%",bottom:"15%",top:"20%",containLabel:!0}})}}catch(e){console.error("加载趋势数据失败:",e),L.setOption({title:{text:Z.value==="month"?"最新一个月数据趋势":"最近一年数据趋势",subtext:"数据加载失败",left:"center",textStyle:{fontSize:12,color:"#a0cfff"}},xAxis:{type:"category",data:[],axisLabel:{color:"#a0cfff"}},yAxis:{type:"value",name:"测量值",nameTextStyle:{color:"#a0cfff"},min:0,max:100},series:[{name:"数据趋势",type:"line",data:[]}]})}},Oe=a=>{Le.value=a.id,V.value=a,nt(a.instrument_id);const e=Lt(a.instrument_id);if(e.length>0&&x.value==="dam3"){const l=e[0];ut(l)}else ie(),q.value=""},it=()=>{P.value&&(y=new Cesium.Viewer(P.value,{animation:!1,timeline:!1,baseLayerPicker:!1,geocoder:!1,homeButton:!1,sceneModePicker:!1,navigationHelpButton:!1,fullscreenButton:!1,selectionIndicator:!1,infoBox:!1,terrainProvider:new Cesium.EllipsoidTerrainProvider,imageryProvider:new Cesium.UrlTemplateImageryProvider({url:"https://tile.openstreetmap.org/{z}/{x}/{y}.png"})}),y.camera.setView({destination:Cesium.Cartesian3.fromDegrees(118.746,32.06,1e3),orientation:{heading:Cesium.Math.toRadians(0),pitch:Cesium.Math.toRadians(-45),roll:0}}),He(),dt())},He=()=>{if(!y)return;z&&(y.entities.remove(z),z=null);const a=Cesium.Cartesian3.fromDegrees(118.746,32.06,30);let e="/models/dam1.glb";x.value==="dam2"?e="/models/dam2.glb":x.value==="dam3"&&(e="/models/dam3.glb"),z=y.entities.add({position:a,model:{uri:e,scale:5,minimumPixelSize:128,maximumScale:100}}),y.zoomTo(z),x.value==="dam3"?setTimeout(()=>{rt()},1e3):Re()},rt=()=>{!y||!z||(Re(),ct())},ct=()=>{te=new Cesium.ScreenSpaceEventHandler(y.scene.canvas),te.setInputAction(a=>{const e=y.scene.pick(a.endPosition);if(Cesium.defined(e)&&e.detail&&e.detail.node){const l=e.detail.node._name||e.detail.node.name;if(l){const o=String(l);K.value=o}else K.value="模型表面"}else K.value=""},Cesium.ScreenSpaceEventType.MOUSE_MOVE),ae=new Cesium.ScreenSpaceEventHandler(y.scene.canvas),ae.setInputAction(a=>{const e=y.scene.pick(a.position);if(Cesium.defined(e)&&e.detail&&e.detail.node){const l=e.detail.node._name||e.detail.node.name;if(l){const o=String(l);ee.value=o;const r=It(o);if(be.value=r,r){const u=T.value.find(n=>n.instrument_id===r);u?(Oe(u),D.success(`已选择分块: ${o} → 仪器: ${r}`)):D.warning(`找到分块: ${o}，但未找到对应的测点仪器: ${r}`)}else D.warning(`找到分块: ${o}，但未找到对应的仪器映射`)}else ee.value="点击了模型表面",D.info("点击了模型表面，请尝试点击模型的不同部分")}else ee.value="点击了模型表面",D.info("点击了模型表面，请尝试点击模型的不同部分")},Cesium.ScreenSpaceEventType.LEFT_CLICK)},Re=()=>{te&&(te.destroy(),te=null),ae&&(ae.destroy(),ae=null),K.value=""},ut=a=>{if(!y||!z)return;const e=z.model;if(!e||!e._runtime||!e._runtime._model)return;const l=e._runtime._model;if(!a||q.value===a){ie(),q.value="";return}q.value=a;try{if(l.silhouetteSize=5,l.silhouetteColor=Cesium.Color.YELLOW,y.scene.globe.depthTestAgainstTerrain=!1,l.style){const o=new Cesium.Cesium3DTileStyle({color:{conditions:[[`\${name} === '${a}'`,"color('lime')"],["true","color('rgba(128, 128, 128, 0.3)')"]]}});l.style=o}else if(l._sceneGraph&&l._sceneGraph._runtimeNodes){const o=l._sceneGraph._runtimeNodes;let r=!1;for(const u of o){const n=u._name||u.name;if(n)if(n===a)try{u.color=Cesium.Color.LIME,r=!0}catch(m){console.warn("无法设置节点颜色:",m)}else try{u.color=Cesium.Color.GRAY.withAlpha(.3)}catch{}}r||(console.warn(`未找到组件: ${a}`),ie(),q.value="")}}catch(o){console.error("高亮组件失败:",o),ie(),q.value=""}},ie=()=>{if(!y||!z)return;const a=z.model;if(!a||!a._runtime||!a._runtime._model)return;const e=a._runtime._model;try{if(e.silhouetteSize=0,y.scene.globe.depthTestAgainstTerrain=!0,e.style&&(e.style=new Cesium.Cesium3DTileStyle({color:"color('white')"})),e._sceneGraph&&e._sceneGraph._runtimeNodes){const l=e._sceneGraph._runtimeNodes;for(const o of l)try{o.color=Cesium.Color.WHITE}catch{}}}catch(l){console.error("重置高亮失败:",l)}},dt=()=>{if(y){for(const a of ke.values())y.entities.remove(a);ke.clear()}},mt=()=>{y&&y.camera.setView({destination:Cesium.Cartesian3.fromDegrees(118.746,32.06,1e3),orientation:{heading:Cesium.Math.toRadians(0),pitch:Cesium.Math.toRadians(-45),roll:0}})},ft=()=>{const a=document.querySelector(".monitor-container");document.fullscreenElement?document.exitFullscreen():a.requestFullscreen().catch(e=>{console.error("全屏失败:",e)})},Ge=async()=>{if($)try{const a=parseInt(O.value),e=await Ee({interval:"month",instrument_id:"上游",end_time:`${a}-12-31 23:59:59`,limit:12}),l=["1月","2月","3月","4月","5月","6月","7月","8月","9月","10月","11月","12月"],o={};l.forEach(s=>{o[s]=null}),e.forEach(s=>{const[c,f]=s.period.split("-"),b=`${parseInt(f)}月`;parseInt(c)===a&&o.hasOwnProperty(b)&&(o[b]=s.avg_value)});const r=l.map(s=>o[s]);if(!r.some(s=>s!==null)){$.setOption({title:{text:`上游水位变化 (${O.value})`,subtext:"暂无数据",left:"center",textStyle:{fontSize:12,color:"#a0cfff"}},xAxis:{type:"category",data:l,axisLabel:{color:"#a0cfff"}},yAxis:{type:"value",name:"水位 (m)",nameTextStyle:{color:"#a0cfff"},min:130,max:150},series:[{name:"上游水位",type:"line",data:r,connectNulls:!0}]});return}const n=r.filter(s=>s!==null&&!isNaN(s)),m=n.length>0?Math.min(...n):130,_=n.length>0?Math.max(...n):150;$.setOption({title:{text:`上游水位变化 (${O.value})`,left:"center",textStyle:{fontSize:12,color:"#a0cfff"}},tooltip:{trigger:"axis",formatter:s=>{const c=s[0].name,f=s[0].value;return f!==null?`${c}: ${f.toFixed(2)} m`:`${c}: 无数据`}},xAxis:{type:"category",data:l,axisLabel:{color:"#a0cfff"},axisLine:{lineStyle:{color:"rgba(64, 158, 255, 0.3)"}}},yAxis:{type:"value",name:"水位 (m)",nameTextStyle:{color:"#a0cfff"},axisLabel:{color:"#a0cfff"},axisLine:{lineStyle:{color:"rgba(64, 158, 255, 0.3)"}},splitLine:{lineStyle:{color:"rgba(64, 158, 255, 0.1)"}},min:Math.floor(m*.95),max:Math.ceil(_*1.05)},series:[{name:"上游水位",type:"line",data:r,smooth:!0,itemStyle:{color:"#5B8FF9"},lineStyle:{width:3},areaStyle:{color:new oe(0,0,0,1,[{offset:0,color:"rgba(91, 143, 249, 0.6)"},{offset:1,color:"rgba(91, 143, 249, 0.1)"}])},connectNulls:!0}],grid:{left:"10%",right:"10%",bottom:"15%",top:"20%",containLabel:!0}})}catch(a){console.error("加载上游水位数据失败:",a);const e=["1月","2月","3月","4月","5月","6月","7月","8月","9月","10月","11月","12月"];$.setOption({title:{text:`上游水位变化 (${O.value})`,subtext:"数据加载失败",left:"center",textStyle:{fontSize:12,color:"#a0cfff"}},xAxis:{type:"category",data:e,axisLabel:{color:"#a0cfff"}},yAxis:{type:"value",name:"水位 (m)",nameTextStyle:{color:"#a0cfff"},min:130,max:150},series:[{name:"上游水位",type:"line",data:[]}]})}},Ue=async()=>{if(k)try{const a=parseInt(H.value),e=await Ee({interval:"month",instrument_id:"下游",end_time:`${a}-12-31 23:59:59`,limit:12}),l=["1月","2月","3月","4月","5月","6月","7月","8月","9月","10月","11月","12月"],o={};l.forEach(s=>{o[s]=null}),e.forEach(s=>{const[c,f]=s.period.split("-"),b=`${parseInt(f)}月`;parseInt(c)===a&&o.hasOwnProperty(b)&&(o[b]=s.avg_value)});const r=l.map(s=>o[s]);if(!r.some(s=>s!==null)){k.setOption({title:{text:`下游水位变化 (${H.value})`,subtext:"暂无数据",left:"center",textStyle:{fontSize:12,color:"#a0cfff"}},xAxis:{type:"category",data:l,axisLabel:{color:"#a0cfff"}},yAxis:{type:"value",name:"水位 (m)",nameTextStyle:{color:"#a0cfff"},min:120,max:140},series:[{name:"下游水位",type:"line",data:r,connectNulls:!0}]});return}const n=r.filter(s=>s!==null&&!isNaN(s)),m=n.length>0?Math.min(...n):120,_=n.length>0?Math.max(...n):140;k.setOption({title:{text:`下游水位变化 (${H.value})`,left:"center",textStyle:{fontSize:12,color:"#a0cfff"}},tooltip:{trigger:"axis",formatter:s=>{const c=s[0].name,f=s[0].value;return f!==null?`${c}: ${f.toFixed(2)} m`:`${c}: 无数据`}},xAxis:{type:"category",data:l,axisLabel:{color:"#a0cfff"},axisLine:{lineStyle:{color:"rgba(64, 158, 255, 0.3)"}}},yAxis:{type:"value",name:"水位 (m)",nameTextStyle:{color:"#a0cfff"},axisLabel:{color:"#a0cfff"},axisLine:{lineStyle:{color:"rgba(64, 158, 255, 0.3)"}},splitLine:{lineStyle:{color:"rgba(64, 158, 255, 0.1)"}},min:Math.floor(m*.95),max:Math.ceil(_*1.05)},series:[{name:"下游水位",type:"line",data:r,smooth:!0,itemStyle:{color:"#E86452"},lineStyle:{width:3},areaStyle:{color:new oe(0,0,0,1,[{offset:0,color:"rgba(232, 100, 82, 0.6)"},{offset:1,color:"rgba(232, 100, 82, 0.1)"}])},connectNulls:!0}],grid:{left:"10%",right:"10%",bottom:"15%",top:"20%",containLabel:!0}})}catch(a){console.error("加载下游水位数据失败:",a);const e=["1月","2月","3月","4月","5月","6月","7月","8月","9月","10月","11月","12月"];k.setOption({title:{text:`下游水位变化 (${H.value})`,subtext:"数据加载失败",left:"center",textStyle:{fontSize:12,color:"#a0cfff"}},xAxis:{type:"category",data:e,axisLabel:{color:"#a0cfff"}},yAxis:{type:"value",name:"水位 (m)",nameTextStyle:{color:"#a0cfff"},min:120,max:140},series:[{name:"下游水位",type:"line",data:[]}]})}};Se(O,()=>{Ge()}),Se(H,()=>{Ue()}),Se(Z,()=>{V.value&&L&&Be(V.value.instrument_id)});const vt=()=>{fe.value&&($&&$.dispose(),$=de(fe.value),Ge()),ve.value&&(k&&k.dispose(),k=de(ve.value),Ue())},pt=async()=>{if(V.value)try{const a=await J({instrument_id:V.value.instrument_id,limit:1e3}),o=[["测量时间","监测类型","仪器编号","测量值","单位","水位值"].join(","),...a.map(m=>[`"${m.measure_time}"`,`"${m.type_name}"`,`"${m.instrument_id}"`,m.value,`"${m.unit}"`,m.water_level||""].join(","))].join(`
`),r=new Blob([o],{type:"text/csv;charset=utf-8;"}),u=document.createElement("a"),n=URL.createObjectURL(r);u.setAttribute("href",n),u.setAttribute("download",`${V.value.name}_${V.value.instrument_id}_数据.csv`),u.style.visibility="hidden",document.body.appendChild(u),u.click(),document.body.removeChild(u),D.success("数据导出成功")}catch(a){console.error("导出数据失败:",a),D.error("导出数据失败")}};return _t(async()=>{try{C.value=await ht()}catch(e){console.error("加载用户信息失败:",e);const l=localStorage.getItem("user_info");if(l)try{C.value=JSON.parse(l)}catch{C.value={username:"用户",role:"user"}}}De();const a=setInterval(De,1e3);await Promise.all([Xe(),Ae(),Fe(),Ve()]),it(),vt(),document.addEventListener("fullscreenchange",()=>{Me.value=!!document.fullscreenElement}),yt(()=>{clearInterval(a),y&&y.destroy(),$&&$.dispose(),k&&k.dispose(),N&&N.dispose(),monthlyTrendChart&&monthlyTrendChart.dispose(),document.removeEventListener("fullscreenchange",()=>{})})}),(a,e)=>{const l=S("el-avatar"),o=S("el-button"),r=S("dv-digital-flop"),u=S("dv-active-ring-chart"),n=S("el-option"),m=S("el-select"),_=S("dv-border-box-8"),s=S("el-radio-button"),c=S("el-radio-group"),f=S("el-table-column"),b=S("el-table"),w=S("dv-border-box-10"),E=S("dv-scroll-board"),we=S("dv-border-box-12"),Ce=S("dv-border-box-13");return X(),G("div",{class:I(["monitor-container",{fullscreen:Me.value}])},[t("div",{ref_key:"viewerEl",ref:P,class:"cesium-viewer"},null,512),t("div",Mt,[e[11]||(e[11]=t("div",{class:"title-section"},[t("h1",null,"智慧水利大坝安全监测平台"),t("p",{class:"subtitle"},"实时监测 · 三维可视化 · 数据分析")],-1)),t("div",Pt,[t("div",zt,[i(l,{size:36,src:F.value},null,8,["src"]),t("div",Tt,[t("div",$t,h(C.value.name||C.value.username),1),t("div",kt,h(C.value.role==="admin"?"管理员":"普通用户"),1)]),gt(xt)?(X(),We(o,{key:0,type:"primary",size:"small",onClick:at},{default:p(()=>[...e[9]||(e[9]=[g("后台管理",-1)])]),_:1})):re("",!0),i(o,{size:"small",onClick:lt},{default:p(()=>[...e[10]||(e[10]=[g("退出",-1)])]),_:1})]),t("div",Dt,[t("div",Xt,h(Pe.value),1),t("div",At,h(ze.value),1)])])]),i(_,{class:I(["floating-window left-window overview-window",{collapsed:U.value}])},{default:p(()=>[t("div",Ft,[e[13]||(e[13]=t("h3",null,[t("i",{class:"el-icon-monitor"}),g(" 监测概览")],-1)),t("div",Vt,[i(o,{size:"small",onClick:ot},{default:p(()=>[...e[12]||(e[12]=[t("i",{class:"el-icon-refresh"},null,-1),g(" 刷新 ",-1)])]),_:1}),i(o,{size:"small",onClick:e[0]||(e[0]=d=>U.value=!U.value)},{default:p(()=>[t("i",{class:I(U.value?"el-icon-full-screen":"el-icon-crop")},null,2),g(" "+h(U.value?"展开":"收起"),1)]),_:1})])]),ce(t("div",Nt,[t("div",Bt,[t("div",Ot,[i(r,{config:he},null,8,["config"]),e[14]||(e[14]=t("div",{class:"stat-label"},"总测量记录",-1))]),t("div",Ht,[i(r,{config:ye},null,8,["config"]),e[15]||(e[15]=t("div",{class:"stat-label"},"监测仪器",-1))]),t("div",Rt,[i(r,{config:ge},null,8,["config"]),e[16]||(e[16]=t("div",{class:"stat-label"},"监测类型",-1))]),t("div",Gt,[i(r,{config:et},null,8,["config"]),e[17]||(e[17]=t("div",{class:"stat-label"},"最新数据年度",-1))])]),t("div",Ut,[e[18]||(e[18]=t("h4",null,"监测类型分布",-1)),i(u,{config:xe,class:"chart-container"},null,8,["config"])]),t("div",jt,[t("div",Wt,[t("div",Yt,[e[19]||(e[19]=t("h4",null,"上游水位变化趋势",-1)),t("div",Kt,[i(m,{modelValue:O.value,"onUpdate:modelValue":e[1]||(e[1]=d=>O.value=d),placeholder:"年份",size:"small",style:{width:"100px"}},{default:p(()=>[i(n,{label:"2018",value:"2018"}),i(n,{label:"2019",value:"2019"}),i(n,{label:"2020",value:"2020"}),i(n,{label:"2021",value:"2021"}),i(n,{label:"2022",value:"2022"}),i(n,{label:"2023",value:"2023"}),i(n,{label:"2024",value:"2024"})]),_:1},8,["modelValue"])])]),t("div",{ref_key:"upstreamChartEl",ref:fe,class:"chart-container"},null,512)]),t("div",qt,[t("div",Jt,[e[20]||(e[20]=t("h4",null,"下游水位变化趋势",-1)),t("div",Qt,[i(m,{modelValue:H.value,"onUpdate:modelValue":e[2]||(e[2]=d=>H.value=d),placeholder:"年份",size:"small",style:{width:"100px"}},{default:p(()=>[i(n,{label:"2018",value:"2018"}),i(n,{label:"2019",value:"2019"}),i(n,{label:"2020",value:"2020"}),i(n,{label:"2021",value:"2021"}),i(n,{label:"2022",value:"2022"}),i(n,{label:"2023",value:"2023"}),i(n,{label:"2024",value:"2024"})]),_:1},8,["modelValue"])])]),t("div",{ref_key:"downstreamChartEl",ref:ve,class:"chart-container"},null,512)])])],512),[[ue,!U.value]])]),_:1},8,["class"]),i(w,{class:I(["floating-window right-window points-window",{collapsed:j.value}])},{default:p(()=>[t("div",Zt,[e[21]||(e[21]=t("h3",null,[t("i",{class:"el-icon-location-information"}),g(" 测点数据")],-1)),t("div",ea,[i(m,{modelValue:ne.value,"onUpdate:modelValue":e[3]||(e[3]=d=>ne.value=d),placeholder:"类型筛选",size:"small",style:{width:"100px"}},{default:p(()=>[i(n,{label:"全部",value:"all"}),(X(!0),G(Ke,null,qe(Ie.value,d=>(X(),We(n,{key:d.id,label:d.name,value:d.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),i(o,{size:"small",onClick:e[4]||(e[4]=d=>j.value=!j.value)},{default:p(()=>[t("i",{class:I(j.value?"el-icon-full-screen":"el-icon-crop")},null,2),g(" "+h(j.value?"展开":"收起"),1)]),_:1})])]),ce(t("div",ta,[t("div",aa,[(X(!0),G(Ke,null,qe(tt.value,d=>{var le;return X(),G("div",{key:d.id,class:I(["point-item",{active:Le.value===d.id}]),onClick:Ha=>Oe(d)},[t("div",oa,[t("div",na,h(d.name),1),t("div",sa,[t("span",ia,h(d.type_name),1),t("span",ra,"仪器: "+h(d.instrument_id),1)])]),t("div",ca,[t("div",ua,h(((le=d.latest_value)==null?void 0:le.toFixed(2))||"--"),1),t("div",da,h(d.unit||""),1)])],10,la)}),128))]),V.value?(X(),G("div",ma,[t("div",fa,[t("div",va,[e[24]||(e[24]=t("h4",null,"最新数据趋势",-1)),t("div",pa,[i(c,{modelValue:Z.value,"onUpdate:modelValue":e[5]||(e[5]=d=>Z.value=d),size:"small"},{default:p(()=>[i(s,{label:"month"},{default:p(()=>[...e[22]||(e[22]=[g("一个月",-1)])]),_:1}),i(s,{label:"year"},{default:p(()=>[...e[23]||(e[23]=[g("一年",-1)])]),_:1})]),_:1},8,["modelValue"])])]),t("div",{ref_key:"trendChartEl",ref:pe,class:"chart-container",style:{height:"200px"}},null,512)]),t("div",_a,[e[25]||(e[25]=t("div",{class:"chart-header"},[t("h4",null,"仪器使用记录（2018-2024年）")],-1)),t("div",{ref_key:"usageChartEl",ref:_e,class:"chart-container",style:{height:"200px"}},null,512)]),t("div",ha,[t("div",ya,[e[27]||(e[27]=t("h4",null,"历史数据",-1)),t("div",ga,[i(o,{size:"small",onClick:pt,type:"primary"},{default:p(()=>[...e[26]||(e[26]=[t("i",{class:"el-icon-download"},null,-1),g(" 导出CSV ",-1)])]),_:1})])]),t("div",xa,[i(b,{data:se.value,size:"small",height:"200"},{default:p(()=>[i(f,{prop:"measure_time",label:"测量时间",width:"150"}),i(f,{prop:"type_name",label:"监测类型",width:"100"}),i(f,{prop:"instrument_id",label:"仪器编号",width:"100"}),i(f,{prop:"value",label:"测量值",width:"100"},{default:p(({row:d})=>[g(h(d.value.toFixed(2))+" "+h(d.unit),1)]),_:1}),i(f,{prop:"water_level",label:"水位值",width:"100"},{default:p(({row:d})=>[g(h(d.water_level?d.water_level.toFixed(2):"--"),1)]),_:1})]),_:1},8,["data"]),t("div",ba," 共 "+h(se.value.length)+" 条记录，显示最近20条 ",1)])])])):re("",!0)],512),[[ue,!j.value]])]),_:1},8,["class"]),i(we,{class:I(["floating-window bottom-window latest-data-window",{collapsed:W.value}])},{default:p(()=>[t("div",wa,[e[28]||(e[28]=t("h3",null,[t("i",{class:"el-icon-s-data"}),g(" 最新监测数据")],-1)),t("div",Ca,[i(o,{size:"small",onClick:e[6]||(e[6]=d=>W.value=!W.value)},{default:p(()=>[t("i",{class:I(W.value?"el-icon-full-screen":"el-icon-crop")},null,2),g(" "+h(W.value?"展开":"收起"),1)]),_:1})])]),ce(t("div",Sa,[t("div",Ea,[i(E,{config:$e},null,8,["config"])])],512),[[ue,!W.value]])]),_:1},8,["class"]),i(Ce,{class:I(["floating-window model-control-window",{collapsed:Y.value}])},{default:p(()=>[t("div",Ia,[e[29]||(e[29]=t("h3",null,[t("i",{class:"el-icon-map-location"}),g(" 模型控制")],-1)),t("div",La,[i(o,{size:"small",onClick:e[7]||(e[7]=d=>Y.value=!Y.value)},{default:p(()=>[t("i",{class:I(Y.value?"el-icon-full-screen":"el-icon-crop")},null,2),g(" "+h(Y.value?"展开":"收起"),1)]),_:1})])]),ce(t("div",Ma,[t("div",Pa,[i(m,{modelValue:x.value,"onUpdate:modelValue":e[8]||(e[8]=d=>x.value=d),placeholder:"选择模型",size:"small",onChange:He},{default:p(()=>[i(n,{label:"大坝模型1 (dam1.glb)",value:"dam1"}),i(n,{label:"大坝模型2 (dam2.glb)",value:"dam2"}),i(n,{label:"大坝模型3 (dam3.glb)",value:"dam3"})]),_:1},8,["modelValue"]),i(o,{size:"small",onClick:mt},{default:p(()=>[...e[30]||(e[30]=[g("重置视角",-1)])]),_:1}),i(o,{size:"small",onClick:ft},{default:p(()=>[...e[31]||(e[31]=[t("i",{class:"el-icon-full-screen"},null,-1),g(" 全屏 ",-1)])]),_:1})]),t("div",za,[t("div",Ta,[e[32]||(e[32]=t("span",{class:"label"},"当前模型：",-1)),t("span",$a,h(me[x.value]),1)]),t("div",ka,[e[33]||(e[33]=t("span",{class:"label"},"模型格式：",-1)),t("span",Da,h(Qe[x.value]),1)])]),x.value==="dam3"?(X(),G("div",Xa,[t("div",Aa,[e[37]||(e[37]=t("h4",null,[t("i",{class:"el-icon-mouse"}),g(" 分块交互")],-1)),t("div",Fa,[e[34]||(e[34]=t("span",{class:"label"},"悬停分块：",-1)),t("span",{class:I(["value",{highlight:K.value}])},h(K.value||"无"),3)]),t("div",Va,[e[35]||(e[35]=t("span",{class:"label"},"选中分块：",-1)),t("span",{class:I(["value",{highlight:ee.value}])},h(ee.value||"无"),3)]),be.value?(X(),G("div",Na,[e[36]||(e[36]=t("span",{class:"label"},"对应仪器：",-1)),t("span",Ba,h(be.value),1)])):re("",!0),e[38]||(e[38]=t("div",{class:"interaction-hint"},[t("i",{class:"el-icon-info"}),g(" 提示：鼠标悬停可高亮分块，点击分块可查看对应测点数据 ")],-1))])])):re("",!0)],512),[[ue,!Y.value]])]),_:1},8,["class"])],2)}}},ja=Et(Oa,[["__scopeId","data-v-6807add2"]]);export{ja as default};
